# vim: filetype=dockerfile
# Ollama CUDA 12 AMD64 - Промежуточный образ до этапа создания пользователя
# Используется для сохранения прогресса сборки

FROM nvidia/cuda:12.8.0-runtime-ubuntu22.04

LABEL maintainer="DevOps" \
      version="1.0.0-cuda12amd64-intermediate" \
      description="Ollama LLM runtime CUDA 12 AMD64 Linux (intermediate stage)" \
      platform="linux/amd64" \
      cuda.version="12.8"

# Минимальные runtime зависимости (только необходимое) + обновление безопасности
RUN apt-get update && \
    apt-get upgrade -y openssl || true && \
    apt-get install -y --no-install-recommends \
        ca-certificates \
        curl \
        libssl3 \
        zlib1g && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* \
           /tmp/* \
           /var/tmp/* \
           /usr/share/doc \
           /usr/share/man \
           /usr/share/locale \
           /var/cache/apt/archives/*.deb \
           /var/cache/apt/archives/partial/*.deb \
           /var/cache/apt/*.bin && \
    ln -sf /usr/bin/curl /usr/local/bin/curl

# Копируем CUDA библиотеки из переиспользованного builder
COPY --from=olegkarenkikh/ollama:cuda12amd64-cuda-builder /build/dist/lib/ollama /usr/lib/ollama/

# Копируем Go бинарник из переиспользованного builder
COPY --from=olegkarenkikh/ollama:cuda12amd64-go-builder /bin/ollama /usr/bin/ollama

# CUDA environment variables
ENV LD_LIBRARY_PATH=/usr/lib/ollama:/usr/local/cuda/lib64:$LD_LIBRARY_PATH
ENV NVIDIA_DRIVER_CAPABILITIES=compute,utility
ENV NVIDIA_VISIBLE_DEVICES=all
