# Оптимизация Docker образа Ollama для минимального размера

## Цель
Создать минимальный Docker образ с поддержкой только CUDA 12, Linux AMD64, без CVE уязвимостей.

## Оптимизации

### 1. Удаление CPU backend
- **Было**: Собирались оба CPU и CUDA backend (~500MB+ CPU библиотек)
- **Стало**: Только CUDA 12 backend
- **Экономия**: ~500MB

### 2. Удаление Python
- **Было**: Python 3.12 со всеми библиотеками (~200MB)
- **Стало**: Python полностью удален (не используется в runtime)
- **Экономия**: ~200MB

### 3. Минимальный базовый образ
- **Было**: Astra Linux UBI 1.8.1 (полный дистрибутив)
- **Стало**: nvidia/cuda:12.8.0-runtime-ubuntu22.04 (только runtime)
- **Экономия**: ~300-500MB

### 4. Оптимизация Go сборки
- Использование `-ldflags="-w -s"` для удаления debug информации
- `-trimpath` для удаления путей к исходникам
- `-buildmode=pie` для безопасности
- Статическая линковка где возможно

### 5. Очистка зависимостей
- Удаление build-зависимостей из runtime
- Удаление документации, man-страниц, локалей
- Удаление кеша apt
- Минимальный набор runtime библиотек

### 6. Multi-stage build оптимизация
- Отдельные этапы для CUDA и Go
- Очистка временных файлов после каждого этапа
- Минимальное копирование между этапами

## Ожидаемый размер образа

### Исходный образ (Dockerfile)
- Базовый образ Astra UBI: ~200MB
- Python 3.12: ~200MB
- CPU backend: ~500MB
- CUDA backend: ~300MB
- Go binary: ~50MB
- Зависимости: ~100MB
- **Итого**: ~1350MB

### Оптимизированный образ (Dockerfile.minimal-v2)
- Базовый образ CUDA runtime: ~400MB
- CUDA backend: ~300MB
- Go binary: ~30MB (оптимизированный)
- Минимальные зависимости: ~50MB
- **Итого**: ~780MB

### Экономия: ~570MB (42% уменьшение)

## Безопасность (CVE)

### Устраненные CVE
- CVE-2025-47914: Обновление golang.org/x/crypto
- CVE-2025-58181: Обновление зависимостей
- CVE-2024-41996: Использование актуальных версий
- CVE-2025-5222: Обновление yaml.v3

### Дополнительные меры
- Минимальный набор пакетов (меньше поверхность атаки)
- Непривилегированный пользователь
- Статическая линковка где возможно
- Регулярное обновление базового образа

## Использование

### Сборка минимального образа
```bash
docker build -f Dockerfile.minimal-v2 \
  -t olegkarenkikh/ollama:minimal-cuda12 \
  --build-arg PARALLEL=4 \
  .
```

### Проверка размера
```bash
docker images olegkarenkikh/ollama
```

### Сканирование на CVE
```bash
trivy image olegkarenkikh/ollama:minimal-cuda12
grype olegkarenkikh/ollama:minimal-cuda12
```

## Ограничения

1. **Только CUDA 12**: CPU fallback недоступен
2. **Только Linux AMD64**: Другие платформы не поддерживаются
3. **Требуется NVIDIA GPU**: Без GPU образ не будет работать
4. **Минимальные зависимости**: Некоторые функции могут быть недоступны

## Рекомендации

1. Использовать `Dockerfile.minimal-v2` для production
2. Регулярно обновлять базовый образ CUDA
3. Сканировать образ на CVE перед деплоем
4. Мониторить размер образа при обновлениях
