#!/bin/bash
set -e

DOCKER_USER="olegkarenkikh"
IMAGE_NAME="ollama"
LOG_FILE="/tmp/rebuild_variant2.log"

echo "=== ĞŸĞ•Ğ Ğ•Ğ¡Ğ‘ĞĞ ĞšĞ Ğ’ĞĞ Ğ˜ĞĞĞ¢Ğ 2 (minimal) Ğ¡ ĞŸĞ•Ğ Ğ•Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞĞ˜Ğ•Ğœ Ğ¡Ğ›ĞĞ•Ğ’ ==="
echo "Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ²: ${LOG_FILE}"
echo ""

# Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ»Ğ¾Ğ³-Ñ„Ğ°Ğ¹Ğ» Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ¿Ñ€Ğ°Ğ²Ğ°Ğ¼Ğ¸
sudo touch "${LOG_FILE}"
sudo chmod 666 "${LOG_FILE}"

# Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ ÑĞ±Ğ¾Ñ€ĞºĞ¸ Ñ„Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ°
build_final_image() {
    local dockerfile=$1
    local tag=$2
    local build_args=$3
    
    echo "ğŸ”¨ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ñ„Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ° Ğ¸Ğ· ${dockerfile}..."
    local build_output=$(mktemp)
    
    if sudo docker buildx build \
        --platform linux/amd64 \
        -f "${dockerfile}" \
        -t "${DOCKER_USER}/${IMAGE_NAME}:${tag}" \
        --push \
        ${build_args} \
        . 2>&1 | tee -a "${LOG_FILE}" "${build_output}"; then
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ±Ñ‹Ğ» push
        if grep -qE "pushing|pushed|exporting|exported" "${build_output}" && ! grep -qE "ERROR|failed" "${build_output}"; then
            echo "âœ… Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ· ÑĞ¾Ğ±Ñ€Ğ°Ğ½ Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑˆĞµĞ½: ${tag}"
            rm -f "${build_output}"
            return 0
        else
            echo "âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: Ğ¾Ğ±Ñ€Ğ°Ğ· ÑĞ¾Ğ±Ñ€Ğ°Ğ½, Ğ½Ğ¾ push Ğ½Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½ Ğ¸Ğ»Ğ¸ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ğ»ÑÑ Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¾Ğ¹"
            rm -f "${build_output}"
            return 1
        fi
    else
        build_exit_code=$?
        echo "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ±Ğ¾Ñ€ĞºĞ¸ Ñ„Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ° (ĞºĞ¾Ğ´ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ°: ${build_exit_code})"
        rm -f "${build_output}"
        return 1
    fi
}

# ============================================================================
# Ğ’ĞĞ Ğ˜ĞĞĞ¢ 2: Dockerfile.minimal-reuse (Ğ¿ĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ CUDA Ğ¸ GO ÑĞ»Ğ¾Ğ¸)
# ============================================================================
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Ğ’ĞĞ Ğ˜ĞĞĞ¢ 2: Dockerfile.minimal-reuse (Ğ¿ĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ CUDA Ğ¸ GO ÑĞ»Ğ¾Ğ¸)"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# ĞŸĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑƒĞ¶Ğµ ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑˆĞµĞ½Ğ½Ñ‹Ğµ ÑĞ»Ğ¾Ğ¸ Ğ¸Ğ· Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ğ° 1
# CUDA builder: olegkarenkikh/ollama:cuda12amd64-cuda-builder
# GO builder: olegkarenkikh/ollama:cuda12amd64-go-builder

# Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ· (Ğ¿ĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ ÑĞ»Ğ¾Ğ¸ Ğ¸Ğ· Docker Hub)
build_final_image "Dockerfile.minimal-reuse" "minimal" ""

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
if [ $? -eq 0 ]; then
    echo "ğŸ‰ Ğ’ĞĞ Ğ˜ĞĞĞ¢ 2 Ğ£Ğ¡ĞŸĞ•Ğ¨ĞĞ ĞŸĞ•Ğ Ğ•Ğ¡ĞĞ‘Ğ ĞĞ Ğ˜ Ğ—ĞĞŸĞ£Ğ¨Ğ•Ğ!"
else
    echo "âŒ ĞĞ¨Ğ˜Ğ‘ĞšĞ ĞŸĞ Ğ˜ ĞŸĞ•Ğ Ğ•Ğ¡Ğ‘ĞĞ ĞšĞ• Ğ’ĞĞ Ğ˜ĞĞĞ¢Ğ 2"
fi
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
